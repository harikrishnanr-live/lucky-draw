<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload Participants</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-image: url('background.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #4f46e5;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-900 bg-opacity-90 min-h-screen flex flex-col">

<!-- üîó Navbar -->
<nav class="bg-gradient-to-r from-purple-700 to-indigo-700 text-white py-4 shadow">
  <div class="container mx-auto flex justify-between items-center px-4">
    <a href="dashboard.html" class="text-lg font-bold">üéÅ Lucky Draw</a>
    <div class="space-x-4 hidden md:flex">
      <a href="upload-prize.html" class="hover:text-gray-200">Upload Prize</a>
      <a href="upload-participants.html" class="font-semibold text-white">Upload Participants</a>
      <a href="lucky-draw.html" class="hover:text-gray-200">Do Lucky Draw</a>
      <a href="winners.html" class="hover:text-gray-200">View Winners</a>
      <button id="navLogout" class="px-3 py-1 bg-white text-indigo-700 rounded hover:bg-indigo-100 text-sm">Logout</button>
    </div>
  </div>
</nav>

<!-- üì• Upload Section -->
<div class="container mx-auto mt-10 px-4 max-w-2xl">
  <h2 class="text-xl font-semibold text-white mb-4">üë• Upload Participant List (.xlsx: Code)</h2>

  <!-- Dropzone -->
  <div id="dropzone" class="mb-6 rounded-lg border-2 border-dashed border-indigo-400 bg-white bg-opacity-90 p-10 text-center text-gray-700 transition-all duration-300 ease-in-out hover:shadow-md hover:bg-indigo-50 cursor-pointer">
    <p class="text-lg mb-2">üìÇ Drag & Drop Excel File Here</p>
    <p class="text-sm text-gray-500">or click to select file</p>
    <input type="file" id="excelInput" class="hidden" accept=".xlsx" />
  </div>

  <!-- Result Message -->
  <div id="result" class="mb-4 text-sm text-white"></div>

  <!-- Scrollable Table -->
  <div class="max-h-96 overflow-y-auto border border-gray-300 rounded shadow-md bg-white bg-opacity-80">
    <table id="participantTable" class="min-w-full table-auto hidden">
      <thead class="bg-indigo-600 text-white sticky top-0">
        <tr>
          <th class="px-4 py-2 text-left">Code</th>
        </tr>
      </thead>
      <tbody class="text-gray-800"></tbody>
    </table>
  </div>
</div>

<!-- üìú Scripts -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("excelInput");
    const logoutBtn = document.getElementById("navLogout");

    dropzone.addEventListener("click", () => fileInput.click());

    dropzone.addEventListener("dragover", e => {
      e.preventDefault();
      dropzone.classList.add("bg-indigo-100", "shadow-lg");
    });

    dropzone.addEventListener("dragleave", () => {
      dropzone.classList.remove("bg-indigo-100", "shadow-lg");
    });

    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      dropzone.classList.remove("bg-indigo-100", "shadow-lg");
      handleFile(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener("change", function () {
      handleFile(this.files[0]);
    });

    logoutBtn.addEventListener("click", () => {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "index.html";
    });

    // Load existing participants on page load
    const stored = JSON.parse(localStorage.getItem("participants") || "[]");
    if (stored.length) {
      renderParticipants(stored);
      document.getElementById("result").innerHTML = `<div class="text-green-400">‚úÖ Loaded ${stored.length} participants from storage.</div>`;
    }
  });

  function handleFile(file) {
    const result = document.getElementById("result");
    const table = document.getElementById("participantTable");
    const tbody = table.querySelector("tbody");

    if (!file || !file.name.endsWith(".xlsx")) {
      result.innerHTML = `<div class="text-red-500">‚ùå Only .xlsx files are accepted.</div>`;
      return;
    }

    result.innerHTML = `<div class="text-indigo-300"><span class="spinner"></span> Processing file...</div>`;

    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const participants = rows.filter(row => row[0]).map(row => row[0]);

        if (participants.length === 0) {
          result.innerHTML = `<div class="text-yellow-400">‚ö†Ô∏è No valid codes found.</div>`;
          return;
        }

        localStorage.setItem("participants", JSON.stringify(participants));
        renderParticipants(participants);
        result.innerHTML = `<div class="text-green-400">‚úÖ Stored ${participants.length} participants.</div>`;
      } catch (err) {
        result.innerHTML = `<div class="text-red-500">‚ùå Error reading file.</div>`;
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function renderParticipants(participants) {
    const table = document.getElementById("participantTable");
    const tbody = table.querySelector("tbody");

    tbody.innerHTML = participants.map(code => `
      <tr class="border-b">
        <td class="px-4 py-2">${code}</td>
      </tr>
    `).join("");

    table.classList.remove("hidden");
  }
</script>
</body>
</html>
